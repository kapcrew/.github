name: –ü–µ—Ä–µ–Ω–æ—Å –∑–∞–¥–∞—á –º–µ–∂–¥—É –∏—Ç–µ—Ä–∞—Ü–∏—è–º–∏ (Projects)

on:
  workflow_dispatch:
    inputs:
      source_iteration:
        description: '–ù–æ–º–µ—Ä –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 133). –û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è'
        required: false
        type: string
      target_iteration:
        description: '–ù–æ–º–µ—Ä —Ç–µ–∫—É—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 136). –û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è'
        required: false
        type: string
      add_comment:
        description: '–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–Ω—ã–º –∑–∞–¥–∞—á–∞–º?'
        required: false
        type: boolean
        default: true
  
  schedule:
    - cron: '*/5 * * * *'  # –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç

jobs:
  move-issues:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # –î–ª—è –∑–∞–ø–∏—Å–∏ —Ñ–∞–π–ª–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
      issues: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PROJECT_PAT }}
      
      - name: –ü–µ—Ä–µ–Ω–æ—Å –∑–∞–¥–∞—á –º–µ–∂–¥—É –∏—Ç–µ—Ä–∞—Ü–∏—è–º–∏ –≤ Projects
        id: move-tasks
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_PAT }}
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É —Å —Ç–µ–∫—É—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–µ–π
            const stateFilePath = '.github/workflows/iteration-state.json';
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —á—Ç–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
            function readState() {
              try {
                if (fs.existsSync(stateFilePath)) {
                  const data = fs.readFileSync(stateFilePath, 'utf8');
                  return JSON.parse(data);
                }
              } catch (error) {
                console.log(`‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª —Å–æ—Å—Ç–æ—è–Ω–∏—è: ${error.message}`);
              }
              
              // –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
              return {
                currentIteration: 136,  // TODO: —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–∫—É—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏
                lastUpdate: null
              };
            }
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
            function saveState(state) {
              try {
                const dir = path.dirname(stateFilePath);
                if (!fs.existsSync(dir)) {
                  fs.mkdirSync(dir, { recursive: true });
                }
                fs.writeFileSync(stateFilePath, JSON.stringify(state, null, 2));
                console.log(`üíæ –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ: —Ç–µ–∫—É—â–∞—è –∏—Ç–µ—Ä–∞—Ü–∏—è = ${state.currentIteration}`);
                return true;
              } catch (error) {
                console.error(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${error.message}`);
                return false;
              }
            }
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–∞–∑–≤–∞–Ω–∏—è –∏—Ç–µ—Ä–∞—Ü–∏–∏
            function normalizeIterationName(input) {
              if (!input) return null;
              // –ï—Å–ª–∏ –≤–≤–µ–¥–µ–Ω–æ —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ, –¥–æ–±–∞–≤–ª—è–µ–º "Iterations "
              if (/^\d+$/.test(input.trim())) {
                return `Iterations ${input.trim()}`;
              }
              return input.trim();
            }
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∑–∞–ø—É—â–µ–Ω –ª–∏ workflow –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é
            const isScheduled = context.eventName === 'schedule';
            const state = readState();
            
            let sourceIterationName, targetIterationName, addComment;
            
            if (isScheduled) {
              // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫: –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑ —Ñ–∞–π–ª–∞
              const sourceNum = state.currentIteration;
              const targetNum = state.currentIteration + 1;
              
              sourceIterationName = normalizeIterationName(sourceNum.toString());
              targetIterationName = normalizeIterationName(targetNum.toString());
              addComment = true;
              
              console.log('‚è∞ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é');
              console.log(`üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: –∏—Ç–µ—Ä–∞—Ü–∏—è ${sourceNum}`);
            } else {
              // –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
              const sourceInput = '${{ github.event.inputs.source_iteration }}';
              const targetInput = '${{ github.event.inputs.target_iteration }}';
              
              if (!sourceInput && !targetInput) {
                // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –≤–≤–µ–¥–µ–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–≤—Ç–æ–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç
                const sourceNum = state.currentIteration;
                const targetNum = state.currentIteration + 1;
                
                sourceIterationName = normalizeIterationName(sourceNum.toString());
                targetIterationName = normalizeIterationName(targetNum.toString());
                
                console.log('üë§ –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —Å –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º –∏—Ç–µ—Ä–∞—Ü–∏–π');
              } else {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–≤–µ–¥–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
                sourceIterationName = normalizeIterationName(sourceInput);
                targetIterationName = normalizeIterationName(targetInput);
                
                console.log('üë§ –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º–∏ –∏—Ç–µ—Ä–∞—Ü–∏—è–º–∏');
              }
              
              addComment = '${{ github.event.inputs.add_comment }}' === 'true';
            }
            
            console.log('üöÄ –ù–∞—á–∏–Ω–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å –∑–∞–¥–∞—á –≤ Projects');
            console.log(`üì§ –ò—Å—Ç–æ—á–Ω–∏–∫: "${sourceIterationName}"`);
            console.log(`üì• –¶–µ–ª—å: "${targetIterationName}"`);
            console.log('---');
            
            const projectNumber = 3; // TODO: –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞ –≤–∞—à –Ω–æ–º–µ—Ä –ø—Ä–æ–µ–∫—Ç–∞
            const owner = context.repo.owner;
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
            async function getAllProjectItems(projectId, iterationFieldId) {
              let allItems = [];
              let hasNextPage = true;
              let cursor = null;
              
              while (hasNextPage) {
                const query = `
                  query($projectId: ID!, $cursor: String) {
                    node(id: $projectId) {
                      ... on ProjectV2 {
                        items(first: 100, after: $cursor) {
                          pageInfo {
                            hasNextPage
                            endCursor
                          }
                          nodes {
                            id
                            content {
                              ... on Issue {
                                number
                                title
                                url
                                state
                              }
                            }
                            fieldValues(first: 20) {
                              nodes {
                                ... on ProjectV2ItemFieldIterationValue {
                                  field {
                                    ... on ProjectV2IterationField {
                                      id
                                      name
                                    }
                                  }
                                  iterationId
                                  title
                                  startDate
                                }
                                ... on ProjectV2ItemFieldSingleSelectValue {
                                  field {
                                    ... on ProjectV2SingleSelectField {
                                      id
                                      name
                                    }
                                  }
                                  name
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                `;
                
                const result = await github.graphql(query, {
                  projectId: projectId,
                  cursor: cursor
                });
                
                const items = result.node.items.nodes;
                allItems = allItems.concat(items);
                
                hasNextPage = result.node.items.pageInfo.hasNextPage;
                cursor = result.node.items.pageInfo.endCursor;
                
                console.log(`üì• –ó–∞–≥—Ä—É–∂–µ–Ω–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤: ${allItems.length}`);
              }
              
              return allItems;
            }
            
            // GraphQL –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ–µ–∫—Ç–µ
            const projectQuery = `
              query($owner: String!, $number: Int!) {
                organization(login: $owner) {
                  projectV2(number: $number) {
                    id
                    title
                    fields(first: 20) {
                      nodes {
                        ... on ProjectV2IterationField {
                          id
                          name
                          configuration {
                            iterations {
                              id
                              title
                              startDate
                              duration
                            }
                            completedIterations {
                              id
                              title
                              startDate
                              duration
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;
            
            let projectData;
            try {
              projectData = await github.graphql(projectQuery, {
                owner: owner,
                number: projectNumber
              });
            } catch (error) {
              core.setFailed(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞: ${error.message}`);
              return;
            }
            
            const project = projectData.organization.projectV2;
            
            // –ù–∞—Ö–æ–¥–∏–º –ø–æ–ª–µ Iterations
            const iterationField = project.fields.nodes.find(field => field.name === 'Iterations');
            
            if (!iterationField) {
              core.setFailed('‚ùå –ü–æ–ª–µ "Iterations" –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –ø—Ä–æ–µ–∫—Ç–µ');
              return;
            }
            
            console.log(`‚úÖ –ù–∞–π–¥–µ–Ω –ø—Ä–æ–µ–∫—Ç: ${project.title}`);
            
            // –û–±—ä–µ–¥–∏–Ω—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∏—Ç–µ—Ä–∞—Ü–∏–∏
            const activeIterations = iterationField.configuration.iterations || [];
            const completedIterations = iterationField.configuration.completedIterations || [];
            const allIterations = [...activeIterations, ...completedIterations];
            
            console.log(`üìä –ù–∞–π–¥–µ–Ω–æ –∏—Ç–µ—Ä–∞—Ü–∏–π: ${allIterations.length}`);
            console.log(`   - –ê–∫—Ç–∏–≤–Ω—ã—Ö: ${activeIterations.length}`);
            console.log(`   - –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö: ${completedIterations.length}`);
            
            // –í—ã–≤–æ–¥–∏–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∏—Ç–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            console.log('üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –∏—Ç–µ—Ä–∞—Ü–∏–∏:');
            allIterations.forEach(iter => {
              console.log(`   - "${iter.title}"`);
            });
            console.log('---');
            
            // –ù–∞—Ö–æ–¥–∏–º –Ω—É–∂–Ω—ã–µ –∏—Ç–µ—Ä–∞—Ü–∏–∏
            const sourceIteration = allIterations.find(i => i.title === sourceIterationName);
            const targetIteration = allIterations.find(i => i.title === targetIterationName);
            
            if (!sourceIteration) {
              core.setFailed(`‚ùå –ò—Ç–µ—Ä–∞—Ü–∏—è "${sourceIterationName}" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞`);
              console.log('üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ (—Å —É—á–µ—Ç–æ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞ –∏ –ø—Ä–æ–±–µ–ª–æ–≤)');
              return;
            }
            
            if (!targetIteration) {
              core.setFailed(`‚ùå –ò—Ç–µ—Ä–∞—Ü–∏—è "${targetIterationName}" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞`);
              console.log('üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ (—Å —É—á–µ—Ç–æ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞ –∏ –ø—Ä–æ–±–µ–ª–æ–≤)');
              return;
            }
            
            console.log(`‚úÖ –ù–∞–π–¥–µ–Ω–∞ –∏—Å—Ö–æ–¥–Ω–∞—è –∏—Ç–µ—Ä–∞—Ü–∏—è: ${sourceIteration.title}`);
            console.log(`‚úÖ –ù–∞–π–¥–µ–Ω–∞ —Ü–µ–ª–µ–≤–∞—è –∏—Ç–µ—Ä–∞—Ü–∏—è: ${targetIteration.title}`);
            console.log('---');
            
            // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞
            console.log('üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞...');
            const allItems = await getAllProjectItems(project.id, iterationField.id);
            console.log(`üìä –í—Å–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ –ø—Ä–æ–µ–∫—Ç–µ: ${allItems.length}`);
            console.log('---');
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º –∑–∞–¥–∞—á–∏ –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏
            const itemsToMove = allItems.filter(item => {
              if (!item.content) return false;
              if (item.content.state === 'CLOSED') return false;
              
              const iterationValue = item.fieldValues.nodes.find(fv => 
                fv.field?.name === 'Iterations' && fv.iterationId
              );
              
              if (!iterationValue) return false;
              
              return iterationValue.iterationId === sourceIteration.id;
            });
            
            console.log(`üìä –ù–∞–π–¥–µ–Ω–æ –∑–∞–¥–∞—á –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞: ${itemsToMove.length}`);
            
            if (itemsToMove.length > 0) {
              console.log('üìã –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞:');
              itemsToMove.forEach(item => {
                console.log(`   - #${item.content.number}: ${item.content.title}`);
              });
            }
            
            if (itemsToMove.length === 0) {
              console.log('‚ú® –ù–µ—Ç –∑–∞–¥–∞—á –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞');
              return;
            }
            
            console.log('---');
            
            let movedCount = 0;
            let errorCount = 0;
            const movedIssues = [];
            const errors = [];
            
            // Mutation –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª—è –∏—Ç–µ—Ä–∞—Ü–∏–∏
            const updateMutation = `
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $iterationId: String!) {
                updateProjectV2ItemFieldValue(
                  input: {
                    projectId: $projectId
                    itemId: $itemId
                    fieldId: $fieldId
                    value: {iterationId: $iterationId}
                  }
                ) {
                  projectV2Item {
                    id
                  }
                }
              }
            `;
            
            // –ü–µ—Ä–µ–Ω–æ—Å–∏–º –∫–∞–∂–¥—É—é –∑–∞–¥–∞—á—É
            for (const item of itemsToMove) {
              try {
                const issue = item.content;
                
                await github.graphql(updateMutation, {
                  projectId: project.id,
                  itemId: item.id,
                  fieldId: iterationField.id,
                  iterationId: targetIteration.id
                });
                
                if (addComment) {
                  try {
                    await github.rest.issues.createComment({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: issue.number,
                      body: `üîÑ –ó–∞–¥–∞—á–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –∏–∑ –∏—Ç–µ—Ä–∞—Ü–∏–∏ **"${sourceIterationName}"** –≤ **"${targetIterationName}"**\n\n_–î–∞—Ç–∞ –ø–µ—Ä–µ–Ω–æ—Å–∞: ${new Date().toLocaleString('ru-RU')}_`
                    });
                  } catch (commentError) {
                    console.log(`‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ #${issue.number}: ${commentError.message}`);
                  }
                }
                
                movedCount++;
                movedIssues.push({
                  number: issue.number,
                  title: issue.title,
                  url: issue.url
                });
                console.log(`‚úÖ #${issue.number}: ${issue.title}`);
                
              } catch (error) {
                errorCount++;
                const errorMsg = `#${item.content?.number}: ${error.message}`;
                errors.push(errorMsg);
                console.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–Ω–æ—Å–µ ${errorMsg}`);
              }
            }
            
            console.log('---');
            console.log(`üìà –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–µ—Ä–µ–Ω–æ—Å–∞:`);
            console.log(`   ‚úÖ –£—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ: ${movedCount}`);
            console.log(`   ‚ùå –û—à–∏–±–æ–∫: ${errorCount}`);
            console.log(`   üìä –í—Å–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${itemsToMove.length}`);
            
            if (errors.length > 0) {
              console.log('\n‚ö†Ô∏è  –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–æ–∫:');
              errors.forEach(err => console.log(`   - ${err}`));
            }
            
            // –°–æ–∑–¥–∞–µ–º issue —Å –æ—Ç—á–µ—Ç–æ–º
            if (movedCount > 0) {
              let reportBody = `## üìã –û—Ç—á–µ—Ç –æ –ø–µ—Ä–µ–Ω–æ—Å–µ –∑–∞–¥–∞—á\n\n`;
              reportBody += `**–ò—Å—Ç–æ—á–Ω–∏–∫:** ${sourceIterationName}\n`;
              reportBody += `**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** ${targetIterationName}\n`;
              reportBody += `**–î–∞—Ç–∞:** ${new Date().toLocaleString('ru-RU')}\n\n`;
              reportBody += `### ‚úÖ –ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –∑–∞–¥–∞—á: ${movedCount}\n\n`;
              
              for (const issue of movedIssues) {
                reportBody += `- #${issue.number} - [${issue.title}](${issue.url})\n`;
              }
              
              if (errorCount > 0) {
                reportBody += `\n### ‚ö†Ô∏è –û—à–∏–±–æ–∫ –ø—Ä–∏ –ø–µ—Ä–µ–Ω–æ—Å–µ: ${errorCount}\n\n`;
                errors.forEach(err => {
                  reportBody += `- ${err}\n`;
                });
              }
              
              try {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `üîÑ –û—Ç—á–µ—Ç: ${sourceIterationName} ‚Üí ${targetIterationName}`,
                  body: reportBody,
                  labels: ['automation', 'report']
                });
                console.log('üìù –°–æ–∑–¥–∞–Ω –æ—Ç—á–µ—Ç –æ –ø–µ—Ä–µ–Ω–æ—Å–µ');
              } catch (error) {
                console.error(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –æ—Ç—á–µ—Ç: ${error.message}`);
              }
            }
            
            console.log('---');
            console.log('üéâ –ü–µ—Ä–µ–Ω–æ—Å –∑–∞–≤–µ—Ä—à–µ–Ω!');
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–µ—Ä–µ–Ω–æ—Å–∞
            if (movedCount > 0) {
              const targetIterationNumber = parseInt(targetIterationName.replace(/\D/g, ''));
              
              if (targetIterationNumber) {
                const newState = {
                  currentIteration: targetIterationNumber,
                  lastUpdate: new Date().toISOString(),
                  lastSourceIteration: sourceIterationName,
                  lastTargetIteration: targetIterationName,
                  movedTasksCount: movedCount
                };
                
                if (saveState(newState)) {
                  console.log(`‚úÖ –°–ª–µ–¥—É—é—â–∏–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –ø–µ—Ä–µ–Ω–µ—Å–µ—Ç –∏–∑ ${targetIterationNumber} –≤ ${targetIterationNumber + 1}`);
                }
              }
            }
      
      - name: Commit state file
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .github/workflows/iteration-state.json || true
          git diff --quiet && git diff --staged --quiet || git commit -m "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏—Ç–µ—Ä–∞—Ü–∏–π [skip ci]"
          git push || echo "No changes to commit"
